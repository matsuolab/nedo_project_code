weight_parallel_dim = {"llma.tok_embeddings.weight": 1, "llma.layers.0.attention.wq.weight": 0,
                       "llma.layers.0.attention.wq.bias": 0, "llma.layers.0.attention.wk.weight": 0,
                       "llma.layers.0.attention.wk.bias": 0, "llma.layers.0.attention.wv.weight": 0,
                       "llma.layers.0.attention.wv.bias": 0, "llma.layers.0.attention.wo.weight": 1,
                       "llma.layers.1.attention.wq.weight": 0, "llma.layers.1.attention.wq.bias": 0,
                       "llma.layers.1.attention.wk.weight": 0, "llma.layers.1.attention.wk.bias": 0,
                       "llma.layers.1.attention.wv.weight": 0, "llma.layers.1.attention.wv.bias": 0,
                       "llma.layers.1.attention.wo.weight": 1, "llma.layers.2.attention.wq.weight": 0,
                       "llma.layers.2.attention.wq.bias": 0, "llma.layers.2.attention.wk.weight": 0,
                       "llma.layers.2.attention.wk.bias": 0, "llma.layers.2.attention.wv.weight": 0,
                       "llma.layers.2.attention.wv.bias": 0, "llma.layers.2.attention.wo.weight": 1,
                       "llma.layers.3.attention.wq.weight": 0, "llma.layers.3.attention.wq.bias": 0,
                       "llma.layers.3.attention.wk.weight": 0, "llma.layers.3.attention.wk.bias": 0,
                       "llma.layers.3.attention.wv.weight": 0, "llma.layers.3.attention.wv.bias": 0,
                       "llma.layers.3.attention.wo.weight": 1, "llma.layers.4.attention.wq.weight": 0,
                       "llma.layers.4.attention.wq.bias": 0, "llma.layers.4.attention.wk.weight": 0,
                       "llma.layers.4.attention.wk.bias": 0, "llma.layers.4.attention.wv.weight": 0,
                       "llma.layers.4.attention.wv.bias": 0, "llma.layers.4.attention.wo.weight": 1,
                       "llma.layers.5.attention.wq.weight": 0, "llma.layers.5.attention.wq.bias": 0,
                       "llma.layers.5.attention.wk.weight": 0, "llma.layers.5.attention.wk.bias": 0,
                       "llma.layers.5.attention.wv.weight": 0, "llma.layers.5.attention.wv.bias": 0,
                       "llma.layers.5.attention.wo.weight": 1, "llma.layers.6.attention.wq.weight": 0,
                       "llma.layers.6.attention.wq.bias": 0, "llma.layers.6.attention.wk.weight": 0,
                       "llma.layers.6.attention.wk.bias": 0, "llma.layers.6.attention.wv.weight": 0,
                       "llma.layers.6.attention.wv.bias": 0, "llma.layers.6.attention.wo.weight": 1,
                       "llma.layers.7.attention.wq.weight": 0, "llma.layers.7.attention.wq.bias": 0,
                       "llma.layers.7.attention.wk.weight": 0, "llma.layers.7.attention.wk.bias": 0,
                       "llma.layers.7.attention.wv.weight": 0, "llma.layers.7.attention.wv.bias": 0,
                       "llma.layers.7.attention.wo.weight": 1, "llma.layers.8.attention.wq.weight": 0,
                       "llma.layers.8.attention.wq.bias": 0, "llma.layers.8.attention.wk.weight": 0,
                       "llma.layers.8.attention.wk.bias": 0, "llma.layers.8.attention.wv.weight": 0,
                       "llma.layers.8.attention.wv.bias": 0, "llma.layers.8.attention.wo.weight": 1,
                       "llma.layers.9.attention.wq.weight": 0, "llma.layers.9.attention.wq.bias": 0,
                       "llma.layers.9.attention.wk.weight": 0, "llma.layers.9.attention.wk.bias": 0,
                       "llma.layers.9.attention.wv.weight": 0, "llma.layers.9.attention.wv.bias": 0,
                       "llma.layers.9.attention.wo.weight": 1, "llma.layers.10.attention.wq.weight": 0,
                       "llma.layers.10.attention.wq.bias": 0, "llma.layers.10.attention.wk.weight": 0,
                       "llma.layers.10.attention.wk.bias": 0, "llma.layers.10.attention.wv.weight": 0,
                       "llma.layers.10.attention.wv.bias": 0, "llma.layers.10.attention.wo.weight": 1,
                       "llma.layers.11.attention.wq.weight": 0, "llma.layers.11.attention.wq.bias": 0,
                       "llma.layers.11.attention.wk.weight": 0, "llma.layers.11.attention.wk.bias": 0,
                       "llma.layers.11.attention.wv.weight": 0, "llma.layers.11.attention.wv.bias": 0,
                       "llma.layers.11.attention.wo.weight": 1, "llma.layers.12.attention.wq.weight": 0,
                       "llma.layers.12.attention.wq.bias": 0, "llma.layers.12.attention.wk.weight": 0,
                       "llma.layers.12.attention.wk.bias": 0, "llma.layers.12.attention.wv.weight": 0,
                       "llma.layers.12.attention.wv.bias": 0, "llma.layers.12.attention.wo.weight": 1,
                       "llma.layers.13.attention.wq.weight": 0, "llma.layers.13.attention.wq.bias": 0,
                       "llma.layers.13.attention.wk.weight": 0, "llma.layers.13.attention.wk.bias": 0,
                       "llma.layers.13.attention.wv.weight": 0, "llma.layers.13.attention.wv.bias": 0,
                       "llma.layers.13.attention.wo.weight": 1, "llma.layers.14.attention.wq.weight": 0,
                       "llma.layers.14.attention.wq.bias": 0, "llma.layers.14.attention.wk.weight": 0,
                       "llma.layers.14.attention.wk.bias": 0, "llma.layers.14.attention.wv.weight": 0,
                       "llma.layers.14.attention.wv.bias": 0, "llma.layers.14.attention.wo.weight": 1,
                       "llma.layers.15.attention.wq.weight": 0, "llma.layers.15.attention.wq.bias": 0,
                       "llma.layers.15.attention.wk.weight": 0, "llma.layers.15.attention.wk.bias": 0,
                       "llma.layers.15.attention.wv.weight": 0, "llma.layers.15.attention.wv.bias": 0,
                       "llma.layers.15.attention.wo.weight": 1, "llma.layers.16.attention.wq.weight": 0,
                       "llma.layers.16.attention.wq.bias": 0, "llma.layers.16.attention.wk.weight": 0,
                       "llma.layers.16.attention.wk.bias": 0, "llma.layers.16.attention.wv.weight": 0,
                       "llma.layers.16.attention.wv.bias": 0, "llma.layers.16.attention.wo.weight": 1,
                       "llma.layers.17.attention.wq.weight": 0, "llma.layers.17.attention.wq.bias": 0,
                       "llma.layers.17.attention.wk.weight": 0, "llma.layers.17.attention.wk.bias": 0,
                       "llma.layers.17.attention.wv.weight": 0, "llma.layers.17.attention.wv.bias": 0,
                       "llma.layers.17.attention.wo.weight": 1, "llma.layers.18.attention.wq.weight": 0,
                       "llma.layers.18.attention.wq.bias": 0, "llma.layers.18.attention.wk.weight": 0,
                       "llma.layers.18.attention.wk.bias": 0, "llma.layers.18.attention.wv.weight": 0,
                       "llma.layers.18.attention.wv.bias": 0, "llma.layers.18.attention.wo.weight": 1,
                       "llma.layers.19.attention.wq.weight": 0, "llma.layers.19.attention.wq.bias": 0,
                       "llma.layers.19.attention.wk.weight": 0, "llma.layers.19.attention.wk.bias": 0,
                       "llma.layers.19.attention.wv.weight": 0, "llma.layers.19.attention.wv.bias": 0,
                       "llma.layers.19.attention.wo.weight": 1, "llma.layers.20.attention.wq.weight": 0,
                       "llma.layers.20.attention.wq.bias": 0, "llma.layers.20.attention.wk.weight": 0,
                       "llma.layers.20.attention.wk.bias": 0, "llma.layers.20.attention.wv.weight": 0,
                       "llma.layers.20.attention.wv.bias": 0, "llma.layers.20.attention.wo.weight": 1,
                       "llma.layers.21.attention.wq.weight": 0, "llma.layers.21.attention.wq.bias": 0,
                       "llma.layers.21.attention.wk.weight": 0, "llma.layers.21.attention.wk.bias": 0,
                       "llma.layers.21.attention.wv.weight": 0, "llma.layers.21.attention.wv.bias": 0,
                       "llma.layers.21.attention.wo.weight": 1, "llma.layers.22.attention.wq.weight": 0,
                       "llma.layers.22.attention.wq.bias": 0, "llma.layers.22.attention.wk.weight": 0,
                       "llma.layers.22.attention.wk.bias": 0, "llma.layers.22.attention.wv.weight": 0,
                       "llma.layers.22.attention.wv.bias": 0, "llma.layers.22.attention.wo.weight": 1,
                       "llma.layers.23.attention.wq.weight": 0, "llma.layers.23.attention.wq.bias": 0,
                       "llma.layers.23.attention.wk.weight": 0, "llma.layers.23.attention.wk.bias": 0,
                       "llma.layers.23.attention.wv.weight": 0, "llma.layers.23.attention.wv.bias": 0,
                       "llma.layers.23.attention.wo.weight": 1, "llma.layers.24.attention.wq.weight": 0,
                       "llma.layers.24.attention.wq.bias": 0, "llma.layers.24.attention.wk.weight": 0,
                       "llma.layers.24.attention.wk.bias": 0, "llma.layers.24.attention.wv.weight": 0,
                       "llma.layers.24.attention.wv.bias": 0, "llma.layers.24.attention.wo.weight": 1,
                       "llma.layers.25.attention.wq.weight": 0, "llma.layers.25.attention.wq.bias": 0,
                       "llma.layers.25.attention.wk.weight": 0, "llma.layers.25.attention.wk.bias": 0,
                       "llma.layers.25.attention.wv.weight": 0, "llma.layers.25.attention.wv.bias": 0,
                       "llma.layers.25.attention.wo.weight": 1, "llma.layers.26.attention.wq.weight": 0,
                       "llma.layers.26.attention.wq.bias": 0, "llma.layers.26.attention.wk.weight": 0,
                       "llma.layers.26.attention.wk.bias": 0, "llma.layers.26.attention.wv.weight": 0,
                       "llma.layers.26.attention.wv.bias": 0, "llma.layers.26.attention.wo.weight": 1,
                       "llma.layers.27.attention.wq.weight": 0, "llma.layers.27.attention.wq.bias": 0,
                       "llma.layers.27.attention.wk.weight": 0, "llma.layers.27.attention.wk.bias": 0,
                       "llma.layers.27.attention.wv.weight": 0, "llma.layers.27.attention.wv.bias": 0,
                       "llma.layers.27.attention.wo.weight": 1, "llma.layers.28.attention.wq.weight": 0,
                       "llma.layers.28.attention.wq.bias": 0, "llma.layers.28.attention.wk.weight": 0,
                       "llma.layers.28.attention.wk.bias": 0, "llma.layers.28.attention.wv.weight": 0,
                       "llma.layers.28.attention.wv.bias": 0, "llma.layers.28.attention.wo.weight": 1,
                       "llma.layers.29.attention.wq.weight": 0, "llma.layers.29.attention.wq.bias": 0,
                       "llma.layers.29.attention.wk.weight": 0, "llma.layers.29.attention.wk.bias": 0,
                       "llma.layers.29.attention.wv.weight": 0, "llma.layers.29.attention.wv.bias": 0,
                       "llma.layers.29.attention.wo.weight": 1, "llma.layers.30.attention.wq.weight": 0,
                       "llma.layers.30.attention.wq.bias": 0, "llma.layers.30.attention.wk.weight": 0,
                       "llma.layers.30.attention.wk.bias": 0, "llma.layers.30.attention.wv.weight": 0,
                       "llma.layers.30.attention.wv.bias": 0, "llma.layers.30.attention.wo.weight": 1,
                       "llma.layers.31.attention.wq.weight": 0, "llma.layers.31.attention.wq.bias": 0,
                       "llma.layers.31.attention.wk.weight": 0, "llma.layers.31.attention.wk.bias": 0,
                       "llma.layers.31.attention.wv.weight": 0, "llma.layers.31.attention.wv.bias": 0,
                       "llma.layers.31.attention.wo.weight": 1, "llma.output.weight": 0, "llma.output.bias": 0}


import json
import argparse
import torch

def merge_sparse(mps, eps, work_dir):
    merged_weights = {}

    for mp in range(mps):
        part_weights = torch.load(f'{work_dir}/consolidated.{mp:02d}-of-{mps:02d}.model.pth', map_location="cpu")['model']

        for key, value in part_weights.items():
            if "feed_forward.w" in key:
                eps_value = torch.chunk(value,eps)
                for ep in range(eps):

                    new_key = key.replace("feed_forward.w",f'feed_forward.experts.{ep}.w')+".weight"
                    if new_key not in merged_weights:
                        merged_weights[new_key] = eps_value[ep]
                    else:
                        merged_weights[new_key] = torch.cat([merged_weights[new_key], eps_value[ep]], dim=0)

            elif key in weight_parallel_dim:
                if key not in merged_weights:
                    merged_weights[key] = value
                else:
                    merged_weights[key] = torch.cat([merged_weights[key], value], dim=weight_parallel_dim[key])
            else:
                merged_weights[key] = value

            #print(f'OK : GPU{mp} -- {key}')
        print(f'OK : GPU{mp}-layer')

    for k,v in merged_weights.items():
        if "w2" in k:
            merged_weights[k] = torch.t(v)
    print(f'OK : w2 transposed')

    torch.save(merged_weights, f'{work_dir}/consolidated.00.pth')
    print(f'OK : save')


def parse_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument("--work_dir", type=str, required=True)
    parser.add_argument("--mp", type=int, required=True)
    args = parser.parse_args()
    print(f"{args = }")
    return args


def main() -> None:
    args = parse_arguments()

    params = {}
    with open(args.work_dir + "/config.json") as f:
        params.update(json.load(f))

    mps = args.mp
    eps = params["moe"]["num_experts"]

    merge_sparse(mps, eps, args.work_dir)

if __name__ == "__main__":
    main()
